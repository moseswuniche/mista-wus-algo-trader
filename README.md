# Trading Bots

This project contains various deployable and runtime configurable trading strategies for cryptocurrencies using the Binance API.

Features include:
- Strategy modularity (inheriting from a common `BaseStrategy`)
- **Component-Based Live Trading:** Live trading logic (`trader.py`) is orchestrated via distinct components (`ClientManager`, `DataHandler`, `PositionManager`, `RiskManager`, `StateManager`, etc.) for better separation of concerns.
- Live trading via WebSockets, managed by the `ClientManager` and `DataHandler` components.
- Configurable Stop Loss, Take Profit, and Trailing Stop Loss, managed by the `PositionManager` and `RiskManager` components.
- Configurable Max Cumulative Loss Stop for the bot, managed by the `RiskManager`.
- **Standardized Backtesting/Forward Testing:** Uses the `backtrader` engine (`backtest.py`) for realistic simulation, including intra-bar SL/TP/TSL checks and consistent configuration via a `BacktestRunConfig` model.
- Calculation of standard performance metrics via `backtrader` analyzers.
- **Parallel** Grid search parameter optimization (`optimize.py`) leveraging the `backtrader` engine.
  - Parameter grids defined in `config/optimize_params.yaml`.
  - Best parameters saved to individual files in `results/optimize/` named `{metric}_best_params_{symbol}_{strategy}.yaml`.
- **Parallel** Batch optimization for multiple strategies/symbols (`run_batch_optimization.py`).
- **Sequential** Batch optimization via `make trigger-threaded-optimizer`.
- Optimization based on selectable performance metrics.
- Simulated forward testing (`forward_test.py`) using the `backtrader` engine and generating HTML reports.
- **Live Trader State Persistence:** Key component states (position, PnL, data buffer) are saved to disk (`results/state/`) allowing the bot to resume gracefully after restarts.
- Saving of detailed optimization results (summary metrics only) to CSV, using batching.
- **Batch Forward Testing:** Script (`run_batch_forward_test.py`) and `make` target (`forward-test-all`) to automatically run forward tests for all optimized results found in `results/optimize/`, using the corresponding best parameter YAML files.
- Historical data fetching (`fetch_data.py`).
- **Universal Filters (Configured via Parameters):**
  - **ATR Volatility Filter:** Avoid trades when Average True Range (ATR) is below a threshold (configured via strategy parameters).
  - **Seasonality Filter:** Restrict trading to specific hours (configured via strategy parameters).
- Type hints and MyPy checking.
- Code formatting using Black.
- Configuration via YAML for optimization (`optimize_params.yaml`), best parameters (`*_best_params_*.yaml`), and runtime (`runtime_config.yaml`).
- Logging across components.
- Runtime configuration reloading for the live trader (`runtime_config_manager.py`).

## Project Structure

```
.
├── .gitignore
├── Makefile
├── README.md
├── config
│   ├── optimize_params.yaml  # Parameter ranges for optimization
│   ├── runtime_config.yaml   # Runtime configuration for the live trader (strategy, params, risk)
│   └── ... (*_best_params_*.yaml files generated by optimize)
├── data                      # Default directory for CSV data (IGNORED)
│   └── ... (CSV files)
├── poetry.lock
├── pyproject.toml
├── results                   # Default directory for generated results (IGNORED)
│   ├── optimize            # Root directory for optimization results
│   │   ├── *.yaml          # Individual best parameter files ({metric}_best_params_{symbol}_{strategy}.yaml)
│   │   └── details         # Detailed optimization CSVs (summary metrics only)
│   ├── forward_test        # Forward test results (plots, reports, trades)
│   │   ├── plots
│   │   ├── reports
│   │   └── trades
│   ├── live_trades         # CSV logs of trades executed by the live trader
│   └── state               # Persisted state files for live trader components
└── src
    └── trading_bots
        ├── __init__.py
        ├── backtest.py         # Backtesting logic using backtrader
        ├── config_models.py    # Pydantic models for configuration validation
        ├── config_utils.py     # Configuration loading utilities (e.g., AWS Secrets)
        ├── data_utils.py       # Data loading utilities
        ├── fetch_data.py       # Script to fetch historical data
        ├── forward_test.py     # Script for simulated forward testing using backtrader
        ├── optimize.py         # Strategy parameter optimization script
        ├── reporting_utils.py  # Shared plotting and reporting functions
        ├── run_batch_forward_test.py # Script to run forward tests for all optimized results
        ├── run_batch_optimization.py # Script to run multiple optimizations in parallel
        ├── technical_indicators.py # Indicator calculation functions
        ├── trader.py           # Main live trading bot orchestrator
        ├── trader_components   # Components for the live trader
        │   ├── __init__.py
        │   ├── client_manager.py   # Handles Binance API client & WebSocket connection
        │   ├── data_handler.py     # Processes incoming data, calculates indicators/signals
        │   ├── order_executor.py   # Executes orders via the client
        │   ├── position_manager.py # Tracks current position, entry price, SL/TP/TSL logic
        │   ├── risk_manager.py     # Enforces risk limits (max loss, etc.)
        │   ├── runtime_config_manager.py # Handles runtime config loading/reloading
        │   ├── state_manager.py    # Manages saving/loading component state
        │   └── trade_logger.py     # Logs executed trades to CSV
        └── strategies
            ├── __init__.py
            ├── base_strategy.py  # Base class inheriting from backtrader.Strategy
            ├── bollinger_band_reversion_strategy.py
            ├── breakout_strategy.py
            ├── hybrid_strategy.py
            ├── ma_crossover_strategy.py
            ├── mean_reversion_strategy.py
            ├── momentum_strategy.py
            └── scalping_strategy.py
```

## Setup

1.  **Clone the repository:**
    ```bash
    git clone <repository_url>
    cd trading_bots
    ```
2.  **Install Dependencies:** Requires Python >= 3.11 and Poetry.
    ```bash
    poetry install --with dev
    ```
3.  **API Keys & AWS Credentials:**
    *   Live trading (`trader.py`) requires API keys.
    *   Using AWS Secrets Manager (`--aws-secret-name`) requires configured AWS credentials (e.g., via environment variables `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_SESSION_TOKEN`, or an IAM role attached to the compute instance).
    *   **Environment Variables (Recommended):** Set `BINANCE...` keys as previously described.
    *   **AWS Secrets Manager (Optional):** Create a secret in AWS Secrets Manager containing a JSON structure with the necessary `BINANCE...` keys (see `src/trading_bots/config_utils.py` for expected format). Provide `--aws-secret-name` and optionally `--aws-region` when running `trader.py`.

## Usage (Makefile)

Use `make help` to see available commands and default variable values.

*   **Install/Update Dependencies:**
    ```bash
    make install
    ```
*   **Fetch Historical Data:**
    ```bash
    make fetch-data # Fetch default symbols/interval
    # Fetch hourly ETH data from 2020:
    make fetch-data FETCH_ARGS="--symbols ETHUSDT --interval 1h --start 2020-01-01"
    ```
*   **Run Strategy Optimization:** Optimizes parameters using grid search based on `config/optimize_params.yaml`. Runs backtests using the `backtrader` engine via `run_backtest`. Saves the best parameters to individual YAML files in `results/optimize/`.
    *   **Single Run (Parallel Backtests):**
        ```bash
        # Optimize MACrossoverStrategy for BTCUSDT daily, maximizing Sharpe, using 6 cores for backtests
        make optimize OPTIMIZE_ARGS="--strategy MovingAverageCrossoverStrategy --symbol BTCUSDT --file data/1d/BTCUSDT_1d.csv --metric sharpe_ratio --save-details --balance 10000 --commission 7.5 -p 6"
        ```
    *   **Batch Run (Parallel Optimizations - `optimize-batch`):**
        ```bash
        # Batch optimize MeanReversionStrategy and BollingerBandReversionStrategy for XRP/ETH hourly
        make optimize-batch STRATEGIES="MeanReversionStrategy BollingerBandReversionStrategy" SYMBOLS="XRPUSDT ETHUSDT" INTERVAL=1h METRIC=max_drawdown START_DATE=2020-01-01 END_DATE=2022-12-31 BALANCE=25000 COMMISSION=5 SAVE_DETAILS=true PROCESSES=4
        ```
    *   **Batch Run (Sequential Trigger - `trigger-threaded-optimizer`):**
        ```bash
        # Sequentially optimize MeanReversionStrategy and BollingerBandReversionStrategy for XRP/ETH hourly
        make trigger-threaded-optimizer TSO_STRATEGIES="MeanReversionStrategy BollingerBandReversionStrategy" TSO_SYMBOLS="XRPUSDT ETHUSDT" TSO_INTERVAL=1h TSO_METRIC=sharpe_ratio TSO_BALANCE=5000 TSO_SAVE_DETAILS=true TSO_PROCESSES=4 RESUME=true
        ```
    *   Configure parameter search ranges in `config/optimize_params.yaml`. Filters (ATR, Seasonality) and risk parameters (SL/TP) are now defined *within* the strategy parameter grid if they are intended to be optimized or controlled per strategy.
    *   Specify optimization target using `METRIC=`/`TSO_METRIC=` or `--metric`.
    *   Use `SAVE_DETAILS=true`/`TSO_SAVE_DETAILS=true` or `--save-details` to save summary metrics CSV.
    *   Use `--resume` (or `RESUME=true`) to resume optimization.
    *   Set initial balance using `BALANCE=`/`TSO_BALANCE=` or `--balance`.
    *   Best parameters saved to `{metric}_best_params_{symbol}_{strategy}.yaml` in `results/optimize/`.
*   **Run Simulated Forward Test:** Runs the `backtrader` engine using the best parameters found during optimization (loaded from individual YAML files) on a *different* historical data period. Generates reports and saves **full trade logs**.
    *   **Single Run:** Uses `make forward-test FWD_ARGS=\"...\"`. Requires specifying the exact `--param-config` file. Filter/risk parameters are loaded from the specified YAML.
        ```bash
        # Test optimized MACrossoverStrategy for BTCUSDT on data from 2023-01-01 onwards
        make forward-test FWD_ARGS=\"--strategy MovingAverageCrossoverStrategy --symbol BTCUSDT --file data/1d/BTCUSDT_1d.csv --param-config results/optimize/sharpe_ratio_best_params_BTCUSDT_MovingAverageCrossoverStrategy.yaml --fwd-start 2023-01-01 --balance 10000 --commission 7.5\"
        ```
    *   **Batch Run (All Optimized Results):** Uses `make forward-test-all`. Automatically finds all `*_best_params_*.yaml` files and runs forward tests. Filter/risk parameters loaded from each file.
        ```bash
        # Run forward tests for ALL optimized results using default settings
        make forward-test-all

        # Run forward tests only for results optimized for \'sharpe_ratio\' on XRPUSDT
        make forward-test-all TARGET_METRIC_ALL=sharpe_ratio INCLUDE_SYMBOLS_ALL=\"XRPUSDT\" FWD_START_ALL=2024-01-01
        ```
    *   Generates HTML reports in `results/forward_test/reports/` and trade logs in `results/forward_test/trades/`.
*   **Analyze Results:** [DEPRECATED/REMOVED] The `analyze-trades.py` script has been removed. Analysis is primarily done via the generated HTML reports from forward testing or by examining the optimization detail CSVs.
*   **Run Live/Simulated Trader (Testnet by Default):** Orchestrates the trader components. Initial strategy, symbol, interval, and units are required arguments. Runtime parameters (including strategy parameters, risk settings like SL/TP/MaxLoss, and filter settings) are loaded from the file specified by `--param-config` (typically a `best_params` file) and can be reloaded via `--runtime-config` (default `config/runtime_config.yaml`). **Note:** Command-line overrides for SL/TP/MaxLoss/Filters are **removed**; configure these via the loaded parameter files.
    ```bash
    # Run ETHUSDT with 5m interval, testnet, loading optimized params
    make trader TRADER_ARGS=\"--symbol ETHUSDT --strategy MovingAverageCrossoverStrategy --interval 5m --units 0.01 --param-config results/optimize/sharpe_ratio_best_params_ETHUSDT_MovingAverageCrossoverStrategy.yaml --commission-bps 7.5 --testnet\"

    # Run LIVE (USE WITH EXTREME CAUTION)
    make trader TRADER_ARGS=\"--symbol BTCUSDT --strategy MeanReversionStrategy --interval 1h --units 0.001 --param-config results/optimize/profit_factor_best_params_BTCUSDT_MeanReversionStrategy.yaml --commission-bps 7.5 --no-testnet\"
    ```
    *   Requires API keys (via env vars or AWS).
    *   Use `--commission-bps` to set commission (default 7.5 = 0.075%).
    *   **Runtime Configuration:** Edit the `--runtime-config` file (default: `config/runtime_config.yaml`) to change `strategy_name`, `strategy_params`, risk management settings (`stop_loss_pct`, `take_profit_pct`, `trailing_stop_loss_pct`, `max_cumulative_loss`), and filter settings (`apply_atr_filter`, `atr_*`, `apply_seasonality_filter`, `allowed_trading_hours_utc`, etc.). Changes are checked periodically by `RuntimeConfigManager` and applied if the bot is flat.
    *   **State Persistence:** Bot state (position, PnL, data buffer) is automatically saved/loaded from `results/state/` by the `StateManager`.
*   **Linting:** `make lint`
*   **Formatting:** `make format`
*   **Clean:** `make clean`

## Output Files

*   `results/optimize/`: Contains optimization results.
    *   `{metric}_best_params_{symbol}_{strategy}.yaml`: Stores the best parameters and metrics found by optimization. Includes strategy, risk, and filter parameters used.
    *   `details/`: Contains detailed CSV logs (summary metrics only) if `SAVE_DETAILS=true` is used.
*   `results/forward_test/reports/`: HTML reports summarizing forward test performance.
*   `results/forward_test/plots/`: PNG equity curves from forward tests.
*   `results/forward_test/trades/`: CSV files detailing individual trades during forward tests.
*   `results/live_trades/`: CSV files logging trades executed by the live trader.
*   `results/state/`: JSON files containing the persisted state of live trader components.

## Adding New Strategies

1.  Create a new Python file in `src/trading_bots/strategies/` (e.g., `my_strategy.py`).
2.  Define a class inheriting from `src.trading_bots.strategies.base_strategy.BaseStrategy` (which inherits from `backtrader.Strategy`).
3.  Define strategy parameters (including any filters or risk parameters like SL/TP if they should be strategy-specific) using the `params = (...)` class attribute tuple, providing defaults.
4.  Implement the `__init__(self)` method:
    *   Call `super().__init__()`.
    *   Define necessary `backtrader` indicators.
    *   Store references to data feeds (e.g., `self.dataclose = self.datas[0].close`).
5.  Implement the `next(self)` method:
    *   Define the core trading logic (buy/sell conditions) based on indicators.
    *   Use `self.buy()`, `self.sell()`, `self.close()` etc. to place orders.
    *   Utilize methods from `BaseStrategy` for common tasks like checking filters (`self.is_trade_allowed()`), logging (`self.log()`), SL/TP setup (`self._get_sl_tp_prices()`), etc. *Do not* implement SL/TP order logic directly here; `BaseStrategy` handles notifications and `PositionManager` handles execution.
6.  Add the new strategy class to the `STRATEGY_CLASS_MAP` dictionary in `src/trading_bots/optimize.py`, `src/trading_bots/forward_test.py`, and `src/trading_bots/trader.py`.
7.  Add parameter search ranges to `config/optimize_params.yaml` under the desired symbols, using the new strategy's **class name** as the key. Include ranges for any base parameters (like `stop_loss_pct`, `apply_atr_filter`, etc.) that you want to optimize for this specific strategy.

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.